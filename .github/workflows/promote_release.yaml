name: Promote RC to GA

on:
  workflow_call:
    inputs:
      rc_version:
        description: "RC version, ej: v1.2.3-rc.2"
        required: true
        type: string
      image-name:
        description: "Nombre base de imagen, ej: app-prueba-java"
        required: true
        type: string
      publish_latest:
        description: "Etiquetar también como :latest"
        required: false
        type: boolean
        default: true
      do_ghcr:
        description: "Promocionar en GHCR"
        required: false
        type: boolean
        default: true
      do_acr:
        description: "Promocionar en ACR"
        required: false
        type: boolean
        default: true
    secrets:
      REGISTRY_USERNAME:
        required: false   # sólo si do_acr=true
      REGISTRY_PASSWORD:
        required: false
      # No hace falta KUBE_CONFIG aquí; esto sólo promociona imágenes y tags
permissions:
  contents: write   # crear tag GA y release GA
  packages: write   # empujar a GHCR

jobs:
  promote:
    runs-on: ubuntu-latest
    outputs:
      ga_version: ${{ steps.compute.outputs.ga_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute GA from RC
        id: compute
        shell: bash
        run: |
          RC="${{ inputs.rc_version }}"
          if ! echo "$RC" | grep -Eq '^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$'; then
            echo "::error::'$RC' no es un RC válido (vX.Y.Z-rc.N)"
            exit 1
          fi
          GA="$(echo "$RC" | sed -E 's/-rc\.[0-9]+$//')"
          echo "GA=$GA"
          echo "ga_version=$GA" >> $GITHUB_OUTPUT
          echo "RC_VERSION=$RC" >> $GITHUB_ENV
          echo "GA_VERSION=$GA" >> $GITHUB_ENV

      - name: Verify GA tag/release don't exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git fetch --tags
          if git rev-parse -q --verify "refs/tags/$GA_VERSION" >/dev/null; then
            echo "::error::Tag GA '$GA_VERSION' ya existe"
            exit 1
          fi
          set +e
          gh release view "$GA_VERSION" >/dev/null 2>&1
          rc=$?
          set -e
          if [ "$rc" -eq 0 ]; then
            echo "::error::Release GA '$GA_VERSION' ya existe"
            exit 1
          fi
          echo "OK: GA no existe aún"

      - name: Setup buildx (para imagetools)
        uses: docker/setup-buildx-action@v3

      # ---------- GHCR: re-etiquetar RC -> GA ----------
      - name: Login GHCR
        if: ${{ inputs.do_ghcr }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote image in GHCR (RC -> GA)
        if: ${{ inputs.do_ghcr }}
        shell: bash
        run: |
          OWNER_LOWER="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          IMAGE_LOWER="$(echo "${{ inputs.image-name }}" | tr '[:upper:]' '[:lower:]')"
          SRC="ghcr.io/${OWNER_LOWER}/${IMAGE_LOWER}:${RC_VERSION}"
          DST_GA="ghcr.io/${OWNER_LOWER}/${IMAGE_LOWER}:${GA_VERSION}"

          echo "Promoviendo GHCR: $SRC -> $DST_GA"
          docker buildx imagetools create -t "$DST_GA" "$SRC"

          if [ "${{ inputs.publish_latest }}" = "true" ]; then
            DST_LATEST="ghcr.io/${OWNER_LOWER}/${IMAGE_LOWER}:latest"
            echo "Adicional: GHCR -> $DST_LATEST"
            docker buildx imagetools create -t "$DST_LATEST" "$SRC"
          fi

      # ---------- ACR: re-etiquetar RC -> GA ----------
      - name: Login ACR
        if: ${{ inputs.do_acr }}
        uses: azure/docker-login@v1
        with:
          login-server: tesiscloud.azurecr.io
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Promote image in ACR (RC -> GA)
        if: ${{ inputs.do_acr }}
        shell: bash
        run: |
          IMAGE_LOWER="$(echo "${{ inputs.image-name }}" | tr '[:upper:]' '[:lower:]')"
          SRC="tesiscloud.azurecr.io/${IMAGE_LOWER}:${RC_VERSION}"
          DST_GA="tesiscloud.azurecr.io/${IMAGE_LOWER}:${GA_VERSION}"

          echo "Promoviendo ACR: $SRC -> $DST_GA"
          docker buildx imagetools create -t "$DST_GA" "$SRC"

          if [ "${{ inputs.publish_latest }}" = "true" ]; then
            DST_LATEST="tesiscloud.azurecr.io/${IMAGE_LOWER}:latest"
            echo "Adicional: ACR -> $DST_LATEST"
            docker buildx imagetools create -t "$DST_LATEST" "$SRC"
          fi

      # ---------- Tags/Release GA en GitHub ----------
      - name: Create GA tag and Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git tag -a "$GA_VERSION" -m "Release $GA_VERSION"
          git push origin "$GA_VERSION"

          gh release create "$GA_VERSION" \
            --title "Release $GA_VERSION" \
            --latest \
            --generate-notes

      - name: Summary
        run: |
          echo "### Promoción completada" >> $GITHUB_STEP_SUMMARY
          echo "- RC: \`${RC_VERSION}\`" >> $GITHUB_STEP_SUMMARY
          echo "- GA: \`${GA_VERSION}\`" >> $GITHUB_STEP_SUMMARY
